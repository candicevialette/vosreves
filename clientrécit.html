<?php
// =================================================================
// SCRIPT POUR ENVOYER LES DONNÉES DU FORMULAIRE À DISCORD
// =================================================================

// 1. URL DE VOTRE WEBHOOK DISCORD
// L'URL que vous avez fournie a été insérée ici.
$webhook_url = 'https://discord.com/api/webhooks/1413146432818647060/XW7Wwsthv5TRnIlkNPojH9Z5mqJLwrDszKYcYMAUGa7HweuldnGjJxd9QY-PzdO65bv8';

// 2. VÉRIFICATION QUE LE FORMULAIRE A BIEN ÉTÉ ENVOYÉ
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    // Si quelqu'un accède à ce script directement sans envoyer le formulaire.
    header('Location: index.html'); // Redirige vers la page d'accueil
    exit();
}

// 3. RÉCUPÉRATION DES DONNÉES DU FORMULAIRE (avec une sécurité de base)
$prenom = htmlspecialchars($_POST['prenom'] ?? 'Non fourni');
$nom_initial = htmlspecialchars($_POST['nom-initial'] ?? 'N');
$destination = htmlspecialchars($_POST['destination'] ?? 'Non fournie');
$recit = htmlspecialchars($_POST['recit'] ?? 'Aucun récit fourni.');

// Limiter la longueur du récit pour l'affichage dans Discord
if (strlen($recit) > 1900) {
    $recit = substr($recit, 0, 1900) . '... (récit trop long pour un aperçu)';
}

// 4. PRÉPARATION DU MESSAGE POUR DISCORD (FORMAT "EMBED")
// C'est ce qui rend le message joli et bien structuré
$embed_data = [
    'username' => 'Soumission - Vos Rêves', // Nom du bot qui poste le message
    'avatar_url' => 'https://i.imgur.com/gLhG8ZU.png', // Logo simple pour le bot
    'embeds' => [
        [
            'title' => 'Nouvelle expérience de voyage à ' . $destination,
            'color' => hexdec('3498db'), // Couleur de la barre latérale (bleu)
            'author' => [
                'name' => $prenom . ' ' . $nom_initial . '.'
            ],
            'fields' => [
                [
                    'name' => 'Destination',
                    'value' => $destination,
                    'inline' => true
                ],
                [
                    'name' => 'Auteur',
                    'value' => $prenom . ' ' . $nom_initial . '.',
                    'inline' => true
                ],
                [
                    'name' => 'Récit de la journée',
                    'value' => $recit
                ],
                [
                    'name' => 'Fichiers',
                    'value' => 'Les photos et vidéos n\'apparaissent pas ici. Elles devront être gérées manuellement à partir de l\'email ou du serveur.'
                ]
            ],
            'footer' => [
                'text' => 'Soumission reçue le ' . date('d/m/Y à H:i')
            ]
        ]
    ]
];

// Convertir les données en format JSON
$json_data = json_encode($embed_data, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);

// 5. ENVOI DES DONNÉES AU WEBHOOK AVEC cURL
$ch = curl_init($webhook_url);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-type: application/json']);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, $json_data);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // Important pour certains hébergeurs

$response = curl_exec($ch);
$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

// 6. AFFICHAGE D'UNE PAGE DE CONFIRMATION À L'UTILISATEUR
// Cette page s'affichera après que l'utilisateur ait cliqué sur "Envoyer"
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Merci pour votre soumission !</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; text-align: center; padding: 50px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        a { display: inline-block; margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: #fff; text-decoration: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <?php
        if ($http_code >= 200 && $http_code < 300) {
            echo "<h1>Merci, " . $prenom . " !</h1><p>Votre expérience a bien été envoyée sur notre serveur. Nous allons l'examiner prochainement.</p>";
        } else {
            echo "<h1>Erreur</h1><p>Une erreur est survenue lors de l'envoi de votre expérience. Veuillez réessayer plus tard ou nous contacter directement.</p>";
            // Pour le débogage, vous pouvez afficher les lignes suivantes (à supprimer en production)
            // echo "<p>Code d'erreur : $http_code</p>";
            // echo "<p>Réponse de Discord : $response</p>";
        }
        ?>
        <a href="index.html">Retour à l'accueil</a>
    </div>
</body>
</html>
